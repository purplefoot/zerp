! Basic unit tests to confirm zerp functionality
! 
! Pretty much everything is written in assembler here, to keep things
! as close to the virtual metal as possible.

Global zerp1 = 0;

[Main x;
    print "Zerp unit test suite v0.1^";
    print "^If you can see this then printing works.";
    print "^The sets are kept in routines for ease of maintainence - so CALL needs to work.^Testing CALL...";
    x = basic_call();
    print "Back in main. Routine should have returned 1, it returned ", x;
    print "^^Beginning tests.....^";
    branch_tests();
    simple_store_tests();
    @quit;
];

[basic_call;
    print "works.^";
    @rtrue;
];

[branch_tests;
    print "Testing branch instructions^";
    test_branch_je();
    test_branch_jl();
    test_branch_jg();
    test_branch_jz();
];

[test_branch_je;
    print "Testing JE^";
    print "JE 1 1...";
    @je 1 1 ?ok;
    jump fail;
.ok;
    print "ok^";
    print "JE@@126 1 1...";
    @je 1 1 ?~fail;
    print "ok^";
    print "JE 1 2...";
    @je 1 2 ?fail;
    print "ok^";
    print "JE@@126 1 2...";
    @je 1 2 ?~ok2;
    jump fail;
.ok2;
    print "ok^";
    print "JE 1 1 2 3...";
    @je 1 1 2 3 ?ok3;
    jump fail;
.ok3;
    print "ok^";
    print "JE@@126 1 1 2 3...";
    @je 1 1 2 3 ?~fail;
    print "ok^";
    print "JE 3 1 2 3...";
    @je 3 1 2 3 ?ok4;
    jump fail;
.ok4;
    print "ok^";
    print "JE 1234 1234...";
    @je 1234 1234 ?ok5;
    jump fail;
.ok5;
    print "ok^";
    print "JE@@126 1234 1234...";
    @je 1234 1234 ?~fail;
    print "ok^";
    print "JE 1234 4321...";
    @je 1234 4321 ?fail;
    print "ok^";
    print "JE@@126 1234 4321...";
    @je 1234 4321 ?~ok6;
    jump fail;
.ok6;
    print "ok^";    
    rtrue;
.fail;
    print "fail^";
    rfalse;
];

[test_branch_jl;
    print "Testing JL^";
    print "JL 1 2...";
    @jl 1 2 ?ok;
    jump fail;
.ok;
    print "ok^";
    print "JL@@126 1 2...";
    @jl 1 2 ?~fail;
    print "ok^";
    print "JL 2 1...";
    @jl 2 1 ?fail;
    print "ok^";
    print "JL@@126 2 1...";
    @jl 2 1 ?~ok2;
    jump fail;
.ok2;
    print "ok^";
    print "JL 1 1...";
    @jl 1 1 ?fail;
    print "ok^";
    print "JL@@126 1 1...";
    @jl 1 1 ?~ok4;
    jump fail;
.ok4;
    print "ok^";
    print "JL -1 1...";
    @jl -1 1 ?ok5;
    jump fail;
.ok5;
    print "ok^";
    print "JL@@126 -1 1...";
    @jl -1 1 ?~fail;
    print "ok^";
    print "JL -1 32655...";
    @jl -1 32655 ?ok6;
    jump fail;
.ok6;
    print "ok^";
    print "JL@@126 -1 32655...";
    @jl -1 32655 ?~fail;
    print "ok^";
    rtrue;
.fail;
    print "fail^";
    rfalse;
];

[test_branch_jg;
    print "Testing JG^";
    print "JG 2 1...";
    @jg 2 1 ?ok;
    jump fail;
.ok;
    print "ok^";
    print "JG@@126 2 1...";
    @jg 2 1 ?~fail;
    print "ok^";
    print "JG 1 2...";
    @jg 1 2 ?fail;
    print "ok^";
    print "JG@@126 1 2...";
    @jg 1 2 ?~ok2;
    jump fail;
.ok2;
    print "ok^";
    print "JG 1 1...";
    @jg 1 1 ?fail;
    print "ok^";
    print "JG@@126 1 1...";
    @jg 1 1 ?~ok4;
    jump fail;
.ok4;
    print "ok^";
    print "JG -1 1...";
    @jg 1 (-1) ?ok5;
    jump fail;
.ok5;
    print "ok^";
    print "JG@@126 1 -1...";
    @jg 1 (-1) ?~fail;
    print "ok^";
    print "JG 32655 -1...";
    @jg 32655 (-1) ?ok6;
    jump fail;
.ok6;
    print "ok^";
    print "JG@@126 32655 -1...";
    @jg 32655 (-1) ?~fail;
    print "ok^";
    rtrue;
.fail;
    print "fail^";
    rfalse;
];

[test_branch_jz;
    print "Testing Jz^";
    print "JZ 0...";
    @jz 0 ?ok;
    jump fail;
.ok;
    print "ok^";
    print "JZ@@126 0...";
    @jz 0 ?~fail;
    print "ok^";
    rtrue;
.fail;
    print "fail^";
    rfalse;
];

[simple_store_tests;
    print "Testing basic storage^";
    print "zerp1 = ", zerp1;
    new_line;
    print "STORE zerp1 ab...";
    @store zerp1 $ab;
    @je zerp1 $ab ?~fail;
    print "ok^";
    print "STORE zerp1 abab...";
    @store zerp1 $abab;
    @je zerp1 $abab ?~fail;
    print "ok^";
    rtrue;
.fail;
    print "fail: ", zerp1;
    new_line;
    print "20 is ", 20;
    new_line;
    rfalse;
];